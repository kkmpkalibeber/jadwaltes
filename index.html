<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Pengawasan Ujian dengan Ruang Off</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .form-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-generate {
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 18px;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            margin-right: 10px;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-copy {
            background-color: #27ae60;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-copy:hover {
            background-color: #219653;
        }
        
        .btn-print {
            background-color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .btn-print:hover {
            background-color: #c0392b;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #3498db;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #e74c3c;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
            display: none;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
            display: none;
        }
        
        .off-rooms-section {
            background-color: #fff8e1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .off-rooms-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #856404;
            font-size: 16px;
        }
        
        .off-rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .off-room-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .off-room-checkbox {
            width: 20px;
            height: 20px;
        }
        
        .off-room-label {
            font-size: 14px;
        }
        
        .result-section {
            overflow-x: auto;
            margin-top: 30px;
            display: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f7fd;
        }
        
        .ruang-header {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        .ruang-header.off {
            background-color: #95a5a6;
            color: #7f8c8d;
        }
        
        .ruang-subheader {
            background-color: #5dade2;
            color: white;
            font-weight: bold;
        }
        
        .ruang-subheader.off {
            background-color: #bdc3c7;
            color: #7f8c8d;
        }
        
        .sesi-header {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
        }
        
        .pengawas-cell {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .cell-off {
            background-color: #f8f9fa;
            color: #95a5a6;
            font-style: italic;
        }
        
        .validation-results {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .validation-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .validation-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
        }
        
        .validation-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .icon-ok {
            background-color: #28a745;
        }
        
        .icon-warning {
            background-color: #ffc107;
        }
        
        .icon-error {
            background-color: #dc3545;
        }
        
        .validation-text {
            flex: 1;
        }
        
        .validation-detail {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .copy-instruction {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
            }
            
            table {
                box-shadow: none;
            }
            
            th {
                background-color: #2c3e50 !important;
                -webkit-print-color-adjust: exact;
                color: white !important;
            }
            
            .cell-off {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .container {
                padding: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .off-rooms-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jadwal Pengawasan Ujian dengan Ruang Off</h1>
        <p class="subtitle">Generate jadwal pengawas dengan kemampuan menangani ruang yang off di sesi tertentu</p>
        
        <div class="form-section">
            <div class="alert alert-info" id="infoAlert">
                <strong>Fitur Baru:</strong> Dapat menetapkan ruang yang off di sesi tertentu. Pengawas di ruang off akan libur di sesi tersebut.
            </div>
            
            <div class="alert alert-error" id="errorAlert">
                Jumlah pengawas harus minimal 2x jumlah ruang. Setiap ruang memerlukan 2 pengawas per sesi.
            </div>
            
            <div class="alert alert-success" id="successAlert">
                Jadwal berhasil digenerate! Silakan salin tabel di bawah untuk di-paste ke Excel.
            </div>
            
            <div class="alert alert-warning" id="warningAlert">
                Beberapa ruang di sesi tertentu akan off. Pengawas di ruang tersebut akan libur.
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="sesiCount">Jumlah Sesi</label>
                    <input type="number" id="sesiCount" min="1" max="10" value="5">
                </div>
                
                <div class="form-group">
                    <label for="ruangCount">Jumlah Ruang</label>
                    <input type="number" id="ruangCount" min="1" max="30" value="8">
                </div>
                
                <div class="form-group">
                    <label for="pengawasCount">Jumlah Pengawas</label>
                    <input type="number" id="pengawasCount" min="2" max="100" value="20">
                </div>
            </div>
            
            <div id="offRoomsContainer">
                <!-- Dinamis diisi oleh JavaScript -->
            </div>
            
            <button class="btn btn-generate" id="generateBtn">Generate Jadwal dengan Ruang Off</button>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="no-print">
                <h2>Jadwal Pengawasan</h2>
                <p>Jadwal berikut mempertimbangkan ruang yang off di sesi tertentu.</p>
                
                <div class="copy-instruction" id="copyInstruction">
                    <strong>Instruksi Copy ke Excel:</strong> Klik tombol "Select All" untuk memilih seluruh tabel, lalu tekan Ctrl+C untuk menyalin. Buka Excel dan paste dengan Ctrl+V.
                </div>
                
                <div>
                    <button class="btn btn-copy" id="selectAllBtn">Select All (Untuk Copy ke Excel)</button>
                    <button class="btn btn-print" id="printBtn">Cetak PDF / Print</button>
                    <button class="btn btn-secondary" id="toggleOffRoomsBtn">Tampilkan/Sembunyikan Ruang Off</button>
                </div>
            </div>
            
            <div id="scheduleTableContainer"></div>
            
            <div class="validation-results" id="validationResults">
                <div class="validation-title">Hasil Validasi Jadwal</div>
                <div id="validationItems"></div>
            </div>
            
            <div class="stats" id="statsContainer"></div>
        </div>
        
        <div class="footer no-print">
            <p>Jadwal Pengawasan Ujian &copy; 2023 | Dengan fitur penanganan ruang off di sesi tertentu</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sesiCountInput = document.getElementById('sesiCount');
            const ruangCountInput = document.getElementById('ruangCount');
            const pengawasCountInput = document.getElementById('pengawasCount');
            const generateBtn = document.getElementById('generateBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const printBtn = document.getElementById('printBtn');
            const toggleOffRoomsBtn = document.getElementById('toggleOffRoomsBtn');
            const resultSection = document.getElementById('resultSection');
            const scheduleTableContainer = document.getElementById('scheduleTableContainer');
            const statsContainer = document.getElementById('statsContainer');
            const validationResults = document.getElementById('validationResults');
            const validationItems = document.getElementById('validationItems');
            const infoAlert = document.getElementById('infoAlert');
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            const warningAlert = document.getElementById('warningAlert');
            const copyInstruction = document.getElementById('copyInstruction');
            const offRoomsContainer = document.getElementById('offRoomsContainer');
            
            let offRoomsMap = {}; // Menyimpan ruang off per sesi: {sesi: [ruang1, ruang2, ...]}
            let showOffRooms = true; // Flag untuk toggle tampilan ruang off
            
            // Fungsi untuk mengonversi angka ke huruf (A, B, C, ...)
            function numberToLetter(num) {
                let result = '';
                while (num > 0) {
                    let remainder = (num - 1) % 26;
                    result = String.fromCharCode(65 + remainder) + result;
                    num = Math.floor((num - 1) / 26);
                }
                return result || 'A';
            }
            
            // Fungsi untuk menghasilkan daftar pengawas dengan huruf
            function generatePengawasList(count) {
                const list = [];
                for (let i = 1; i <= count; i++) {
                    list.push(numberToLetter(i));
                }
                return list;
            }
            
            // Fungsi untuk membuat form input ruang off
            function createOffRoomsInputs() {
                const sesiCount = parseInt(sesiCountInput.value) || 5;
                const ruangCount = parseInt(ruangCountInput.value) || 8;
                
                let html = '<div class="off-rooms-section">';
                html += '<div class="off-rooms-title">Tentukan Ruang yang Off per Sesi (Opsional):</div>';
                html += '<p style="font-size: 14px; color: #666; margin-bottom: 15px;">Centang ruang yang akan off di sesi tertentu. Kosongkan jika tidak ada ruang off.</p>';
                
                // Reset offRoomsMap
                offRoomsMap = {};
                
                for (let sesi = 1; sesi <= sesiCount; sesi++) {
                    html += `<div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">`;
                    html += `<div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">Sesi ${sesi}:</div>`;
                    html += '<div class="off-rooms-grid">';
                    
                    for (let ruang = 1; ruang <= ruangCount; ruang++) {
                        const checkboxId = `off-sesi${sesi}-ruang${ruang}`;
                        html += `
                            <div class="off-room-item">
                                <input type="checkbox" id="${checkboxId}" class="off-room-checkbox" 
                                       data-sesi="${sesi}" data-ruang="${ruang}">
                                <label for="${checkboxId}" class="off-room-label">Ruang ${ruang.toString().padStart(2, '0')}</label>
                            </div>
                        `;
                    }
                    
                    html += '</div></div>';
                }
                
                html += '</div>';
                offRoomsContainer.innerHTML = html;
                
                // Tambahkan event listener untuk checkbox
                document.querySelectorAll('.off-room-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateOffRoomsMap);
                });
            }
            
            // Fungsi untuk update offRoomsMap saat checkbox berubah
            function updateOffRoomsMap() {
                const sesi = parseInt(this.dataset.sesi);
                const ruang = parseInt(this.dataset.ruang);
                
                if (!offRoomsMap[sesi]) {
                    offRoomsMap[sesi] = [];
                }
                
                if (this.checked) {
                    // Tambahkan ruang ke daftar off
                    if (!offRoomsMap[sesi].includes(ruang)) {
                        offRoomsMap[sesi].push(ruang);
                    }
                } else {
                    // Hapus ruang dari daftar off
                    offRoomsMap[sesi] = offRoomsMap[sesi].filter(r => r !== ruang);
                }
                
                // Tampilkan warning jika ada ruang off
                const hasOffRooms = Object.values(offRoomsMap).some(arr => arr.length > 0);
                warningAlert.style.display = hasOffRooms ? 'block' : 'none';
            }
            
            // Fungsi untuk menghasilkan jadwal dengan ruang off
            function generateScheduleWithOffRooms() {
                const sesiCount = parseInt(sesiCountInput.value);
                const ruangCount = parseInt(ruangCountInput.value);
                const pengawasCount = parseInt(pengawasCountInput.value);
                
                // Validasi input
                if (pengawasCount < ruangCount * 2) {
                    errorAlert.style.display = 'block';
                    infoAlert.style.display = 'none';
                    successAlert.style.display = 'none';
                    warningAlert.style.display = 'none';
                    resultSection.style.display = 'none';
                    return;
                } else {
                    errorAlert.style.display = 'none';
                    infoAlert.style.display = 'none';
                    successAlert.style.display = 'block';
                    copyInstruction.style.display = 'block';
                }
                
                // Generate daftar pengawas dengan huruf
                const pengawasList = generatePengawasList(pengawasCount);
                
                // Inisialisasi struktur data untuk tracking
                const tugasCount = {};
                const pasanganHistory = {};
                const ruangHistory = {};
                const sesiTugasCount = {}; // Untuk tracking tugas per sesi
                pengawasList.forEach(p => {
                    tugasCount[p] = 0;
                    ruangHistory[p] = [];
                    sesiTugasCount[p] = 0;
                });
                
                // Siapkan data ruang aktif per sesi
                const activeRoomsPerSession = {};
                for (let sesi = 1; sesi <= sesiCount; sesi++) {
                    const offRooms = offRoomsMap[sesi] || [];
                    activeRoomsPerSession[sesi] = [];
                    for (let ruang = 1; ruang <= ruangCount; ruang++) {
                        if (!offRooms.includes(ruang)) {
                            activeRoomsPerSession[sesi].push(ruang);
                        }
                    }
                }
                
                // Algoritma utama untuk menghasilkan jadwal
                const schedule = [];
                
                // Untuk setiap sesi
                for (let sesi = 1; sesi <= sesiCount; sesi++) {
                    const sesiData = { sesi: sesi, ruang: [] };
                    const activeRooms = activeRoomsPerSession[sesi];
                    const offRooms = offRoomsMap[sesi] || [];
                    
                    // Reset tugas sesi untuk pengawas
                    pengawasList.forEach(p => sesiTugasCount[p] = 0);
                    
                    // Untuk setiap ruang (termasuk yang off)
                    for (let ruang = 1; ruang <= ruangCount; ruang++) {
                        if (offRooms.includes(ruang)) {
                            // Ruang off: tidak ada pengawas
                            sesiData.ruang.push({
                                ruang: ruang,
                                pengawas1: null,
                                pengawas2: null,
                                isOff: true
                            });
                        } else {
                            // Ruang aktif: tentukan pengawas
                            // Cari pengawas yang belum bertugas di sesi ini
                            let availablePengawas = pengawasList.filter(p => sesiTugasCount[p] === 0);
                            
                            // Urutkan berdasarkan:
                            // 1. Jumlah tugas keseluruhan (sedikit -> banyak)
                            // 2. Jarang di ruang ini
                            // 3. Variasi random
                            availablePengawas.sort((a, b) => {
                                if (tugasCount[a] !== tugasCount[b]) {
                                    return tugasCount[a] - tugasCount[b];
                                }
                                
                                const freqA = ruangHistory[a].filter(r => r === ruang).length;
                                const freqB = ruangHistory[b].filter(r => r === ruang).length;
                                if (freqA !== freqB) {
                                    return freqA - freqB;
                                }
                                
                                return Math.random() - 0.5;
                            });
                            
                            // Ambil pengawas pertama
                            let pengawas1 = availablePengawas[0];
                            
                            // Cari pasangan
                            let pengawas2 = null;
                            const partnerCandidates = availablePengawas.filter(p => p !== pengawas1);
                            
                            // Coba cari pasangan yang belum pernah bersama
                            for (let candidate of partnerCandidates) {
                                const pasanganKey = [pengawas1, candidate].sort().join('-');
                                if (!pasanganHistory[pasanganKey] || pasanganHistory[pasanganKey] < 1) {
                                    pengawas2 = candidate;
                                    break;
                                }
                            }
                            
                            // Jika tidak ditemukan, ambil kandidat dengan tugas paling sedikit
                            if (!pengawas2 && partnerCandidates.length > 0) {
                                pengawas2 = partnerCandidates[0];
                            }
                            
                            // Jika masih tidak ada, cari dari semua pengawas yang belum bertugas
                            if (!pengawas2) {
                                const allAvailable = pengawasList.filter(p => 
                                    p !== pengawas1 && sesiTugasCount[p] === 0
                                );
                                if (allAvailable.length > 0) {
                                    pengawas2 = allAvailable[0];
                                }
                            }
                            
                            // Jika benar-benar tidak ada, mungkin harus menggunakan pengawas yang sudah bertugas
                            // (seharusnya tidak terjadi jika jumlah pengawas cukup)
                            if (!pengawas2) {
                                // Fallback: cari pengawas dengan tugas sesi paling sedikit
                                const fallbackCandidates = pengawasList.filter(p => 
                                    p !== pengawas1 && sesiTugasCount[p] < 1
                                );
                                if (fallbackCandidates.length > 0) {
                                    fallbackCandidates.sort((a, b) => tugasCount[a] - tugasCount[b]);
                                    pengawas2 = fallbackCandidates[0];
                                }
                            }
                            
                            // Update tracking
                            if (pengawas1 && pengawas2) {
                                sesiTugasCount[pengawas1] = 1;
                                sesiTugasCount[pengawas2] = 1;
                                
                                tugasCount[pengawas1]++;
                                tugasCount[pengawas2]++;
                                
                                const pasanganKey = [pengawas1, pengawas2].sort().join('-');
                                pasanganHistory[pasanganKey] = (pasanganHistory[pasanganKey] || 0) + 1;
                                
                                ruangHistory[pengawas1].push(ruang);
                                ruangHistory[pengawas2].push(ruang);
                                
                                sesiData.ruang.push({
                                    ruang: ruang,
                                    pengawas1: pengawas1,
                                    pengawas2: pengawas2,
                                    isOff: false
                                });
                            } else {
                                // Jika tidak dapat menemukan pasangan, beri placeholder
                                sesiData.ruang.push({
                                    ruang: ruang,
                                    pengawas1: '?',
                                    pengawas2: '?',
                                    isOff: false
                                });
                            }
                        }
                    }
                    
                    schedule.push(sesiData);
                }
                
                // Optimasi untuk pemerataan tugas (khusus pengawas yang aktif)
                optimizeScheduleWithOffRooms(schedule, tugasCount, pasanganHistory, ruangHistory, pengawasList, ruangCount, offRoomsMap);
                
                // Tampilkan jadwal dalam tabel
                displayScheduleWithOffRooms(schedule, pengawasList, sesiCount, ruangCount, offRoomsMap);
                
                // Validasi jadwal
                const validation = validateScheduleWithOffRooms(schedule, pengawasList, sesiCount, ruangCount, offRoomsMap);
                displayValidationResults(validation);
                
                // Tampilkan statistik
                displayStatsWithOffRooms(schedule, pengawasList, validation, offRoomsMap);
                
                // Tampilkan hasil
                resultSection.style.display = 'block';
                validationResults.style.display = 'block';
            }
            
            // Fungsi optimasi untuk jadwal dengan ruang off
            function optimizeScheduleWithOffRooms(schedule, tugasCount, pasanganHistory, ruangHistory, pengawasList, ruangCount, offRoomsMap) {
                const maxIterations = 50;
                
                for (let iter = 0; iter < maxIterations; iter++) {
                    let improved = false;
                    
                    // Hitung selisih tugas hanya untuk pengawas yang pernah bertugas
                    const activePengawas = pengawasList.filter(p => tugasCount[p] > 0);
                    if (activePengawas.length === 0) continue;
                    
                    const tugasValues = activePengawas.map(p => tugasCount[p]);
                    const maxTugas = Math.max(...tugasValues);
                    const minTugas = Math.min(...tugasValues);
                    
                    // Jika selisih sudah kecil (≤ 2), stop
                    if (maxTugas - minTugas <= 2) {
                        break;
                    }
                    
                    // Cari pengawas dengan tugas terbanyak dan tersedikit
                    let pengawasMax = null;
                    let pengawasMin = null;
                    
                    for (let p of activePengawas) {
                        if (tugasCount[p] === maxTugas && !pengawasMax) {
                            pengawasMax = p;
                        }
                        if (tugasCount[p] === minTugas && !pengawasMin) {
                            pengawasMin = p;
                        }
                        if (pengawasMax && pengawasMin) break;
                    }
                    
                    if (!pengawasMax || !pengawasMin) continue;
                    
                    // Coba cari kesempatan untuk menukar pengawasMax dengan pengawasMin
                    for (let sesi = 0; sesi < schedule.length; sesi++) {
                        const offRooms = offRoomsMap[sesi + 1] || [];
                        
                        for (let ruang1 = 0; ruang1 < ruangCount; ruang1++) {
                            const cell1 = schedule[sesi].ruang[ruang1];
                            
                            // Lewati jika ruang off atau tidak ada pengawas
                            if (cell1.isOff || !cell1.pengawas1 || !cell1.pengawas2) continue;
                            
                            // Jika pengawasMax ada di ruang ini
                            if (cell1.pengawas1 === pengawasMax || cell1.pengawas2 === pengawasMax) {
                                // Cari ruang lain di sesi yang sama yang memiliki pengawasMin
                                for (let ruang2 = 0; ruang2 < ruangCount; ruang2++) {
                                    if (ruang2 === ruang1) continue;
                                    
                                    const cell2 = schedule[sesi].ruang[ruang2];
                                    if (cell2.isOff || !cell2.pengawas1 || !cell2.pengawas2) continue;
                                    
                                    if (cell2.pengawas1 === pengawasMin || cell2.pengawas2 === pengawasMin) {
                                        // Coba tukar pengawasMax dengan pengawasMin
                                        if (trySwapPengawas(schedule[sesi], ruang1, ruang2, pengawasMax, pengawasMin, offRooms)) {
                                            // Update tugasCount
                                            tugasCount[pengawasMax]--;
                                            tugasCount[pengawasMin]++;
                                            
                                            improved = true;
                                            break;
                                        }
                                    }
                                    
                                    if (improved) break;
                                }
                            }
                            
                            if (improved) break;
                        }
                        
                        if (improved) break;
                    }
                    
                    if (!improved) break;
                }
            }
            
            // Fungsi untuk mencoba menukar pengawas
            function trySwapPengawas(sesiData, ruang1, ruang2, pengawasMax, pengawasMin, offRooms) {
                const cell1 = sesiData.ruang[ruang1];
                const cell2 = sesiData.ruang[ruang2];
                
                // Buat salinan untuk simulasi
                const simulatedCell1 = { ...cell1 };
                const simulatedCell2 = { ...cell2 };
                
                // Lakukan penukaran
                if (simulatedCell1.pengawas1 === pengawasMax) {
                    simulatedCell1.pengawas1 = pengawasMin;
                } else if (simulatedCell1.pengawas2 === pengawasMax) {
                    simulatedCell1.pengawas2 = pengawasMin;
                }
                
                if (simulatedCell2.pengawas1 === pengawasMin) {
                    simulatedCell2.pengawas1 = pengawasMax;
                } else if (simulatedCell2.pengawas2 === pengawasMin) {
                    simulatedCell2.pengawas2 = pengawasMax;
                }
                
                // Validasi: tidak ada pengawas ganda dalam sesi
                const allPengawas = new Set();
                
                for (let ruang = 0; ruang < sesiData.ruang.length; ruang++) {
                    let p1, p2;
                    
                    if (ruang === ruang1) {
                        p1 = simulatedCell1.pengawas1;
                        p2 = simulatedCell1.pengawas2;
                    } else if (ruang === ruang2) {
                        p1 = simulatedCell2.pengawas1;
                        p2 = simulatedCell2.pengawas2;
                    } else {
                        p1 = sesiData.ruang[ruang].pengawas1;
                        p2 = sesiData.ruang[ruang].pengawas2;
                    }
                    
                    // Lewati jika ruang off
                    if (sesiData.ruang[ruang].isOff) continue;
                    
                    // Validasi
                    if (p1 && p2) {
                        if (allPengawas.has(p1) || allPengawas.has(p2) || p1 === p2) {
                            return false;
                        }
                        allPengawas.add(p1);
                        allPengawas.add(p2);
                    }
                }
                
                // Jika valid, lakukan penukaran sebenarnya
                if (cell1.pengawas1 === pengawasMax) {
                    cell1.pengawas1 = pengawasMin;
                } else if (cell1.pengawas2 === pengawasMax) {
                    cell1.pengawas2 = pengawasMin;
                }
                
                if (cell2.pengawas1 === pengawasMin) {
                    cell2.pengawas1 = pengawasMax;
                } else if (cell2.pengawas2 === pengawasMin) {
                    cell2.pengawas2 = pengawasMax;
                }
                
                return true;
            }
            
            // Fungsi validasi untuk jadwal dengan ruang off
            function validateScheduleWithOffRooms(schedule, pengawasList, sesiCount, ruangCount, offRoomsMap) {
                const results = {
                    noDoubleInSession: { valid: true, details: [] },
                    differentPartnerEachSession: { valid: true, details: [], repeatCount: 0 },
                    taskDistribution: { valid: true, details: [], maxDiff: 0 },
                    offRoomsHandled: { valid: true, details: [] }
                };
                
                // Tracking
                const partnerHistory = {};
                const taskCount = {};
                pengawasList.forEach(p => {
                    partnerHistory[p] = new Set();
                    taskCount[p] = 0;
                });
                
                // Validasi 1: Tidak ada pengawas ganda dalam 1 sesi
                for (let sesi = 0; sesi < schedule.length; sesi++) {
                    const pengawasInSession = new Set();
                    const offRooms = offRoomsMap[sesi + 1] || [];
                    
                    for (let ruang = 0; ruang < ruangCount; ruang++) {
                        const cell = schedule[sesi].ruang[ruang];
                        
                        // Lewati ruang off
                        if (offRooms.includes(ruang + 1)) continue;
                        
                        if (!cell.pengawas1 || !cell.pengawas2) {
                            results.noDoubleInSession.details.push(
                                `Sesi ${sesi + 1}, Ruang ${ruang + 1}: Tidak ada pengawas`
                            );
                            results.noDoubleInSession.valid = false;
                            continue;
                        }
                        
                        if (pengawasInSession.has(cell.pengawas1) || pengawasInSession.has(cell.pengawas2)) {
                            results.noDoubleInSession.details.push(
                                `Sesi ${sesi + 1}: Pengawas ganda ditemukan (${cell.pengawas1}, ${cell.pengawas2})`
                            );
                            results.noDoubleInSession.valid = false;
                        }
                        
                        pengawasInSession.add(cell.pengawas1);
                        pengawasInSession.add(cell.pengawas2);
                        
                        // Update task count
                        taskCount[cell.pengawas1]++;
                        taskCount[cell.pengawas2]++;
                    }
                }
                
                // Validasi 2: Pasangan berbeda setiap sesi
                for (let sesi = 0; sesi < schedule.length; sesi++) {
                    const offRooms = offRoomsMap[sesi + 1] || [];
                    
                    for (let ruang = 0; ruang < ruangCount; ruang++) {
                        if (offRooms.includes(ruang + 1)) continue;
                        
                        const cell = schedule[sesi].ruang[ruang];
                        if (!cell.pengawas1 || !cell.pengawas2) continue;
                        
                        // Cek apakah pasangan ini sudah pernah bersama
                        if (partnerHistory[cell.pengawas1].has(cell.pengawas2) || 
                            partnerHistory[cell.pengawas2].has(cell.pengawas1)) {
                            results.differentPartnerEachSession.repeatCount++;
                            results.differentPartnerEachSession.details.push(
                                `Sesi ${sesi + 1}, Ruang ${ruang + 1}: ${cell.pengawas1} & ${cell.pengawas2} sudah pernah bersama`
                            );
                        }
                        
                        partnerHistory[cell.pengawas1].add(cell.pengawas2);
                        partnerHistory[cell.pengawas2].add(cell.pengawas1);
                    }
                }
                
                if (results.differentPartnerEachSession.repeatCount > 0) {
                    results.differentPartnerEachSession.valid = false;
                }
                
                // Validasi 3: Pemerataan tugas (hitung hanya pengawas yang aktif)
                const activePengawas = pengawasList.filter(p => taskCount[p] > 0);
                if (activePengawas.length > 0) {
                    const taskValues = activePengawas.map(p => taskCount[p]);
                    const maxTask = Math.max(...taskValues);
                    const minTask = Math.min(...taskValues);
                    results.taskDistribution.maxDiff = maxTask - minTask;
                    
                    if (results.taskDistribution.maxDiff > 2) {
                        results.taskDistribution.valid = false;
                        results.taskDistribution.details.push(
                            `Selisih tugas terlalu besar: ${minTask} - ${maxTask} (selisih: ${results.taskDistribution.maxDiff})`
                        );
                    }
                }
                
                // Validasi 4: Ruang off ditangani dengan benar
                let offRoomsCount = 0;
                for (let sesi = 1; sesi <= sesiCount; sesi++) {
                    const offRooms = offRoomsMap[sesi] || [];
                    offRoomsCount += offRooms.length;
                    
                    for (let ruang of offRooms) {
                        const cell = schedule[sesi - 1].ruang[ruang - 1];
                        if (!cell.isOff || cell.pengawas1 !== null || cell.pengawas2 !== null) {
                            results.offRoomsHandled.details.push(
                                `Sesi ${sesi}, Ruang ${ruang}: Tidak ditandai sebagai off dengan benar`
                            );
                            results.offRoomsHandled.valid = false;
                        }
                    }
                }
                
                if (offRoomsCount > 0) {
                    results.offRoomsHandled.details.push(
                        `Total ${offRoomsCount} ruang off ditangani`
                    );
                }
                
                return results;
            }
            
            // Fungsi untuk menampilkan hasil validasi
            function displayValidationResults(validation) {
                let html = '';
                
                // 1. Validasi tidak ada pengawas ganda
                html += `
                    <div class="validation-item">
                        <div class="validation-icon ${validation.noDoubleInSession.valid ? 'icon-ok' : 'icon-error'}">
                            ${validation.noDoubleInSession.valid ? '✓' : '✗'}
                        </div>
                        <div class="validation-text">
                            <strong>Tidak ada pengawas ganda dalam 1 sesi</strong>
                            <div class="validation-detail">
                                ${validation.noDoubleInSession.valid ? 
                                    '✓ Semua pengawas hanya mengawasi 1 ruang per sesi' : 
                                    '✗ Ditemukan pengawas yang mengawasi lebih dari 1 ruang'}
                            </div>
                        </div>
                    </div>
                `;
                
                // 2. Validasi pasangan berbeda
                html += `
                    <div class="validation-item">
                        <div class="validation-icon ${validation.differentPartnerEachSession.valid ? 'icon-ok' : 'icon-warning'}">
                            ${validation.differentPartnerEachSession.valid ? '✓' : '⚠'}
                        </div>
                        <div class="validation-text">
                            <strong>Minimalisasi pasangan yang sama di sesi berbeda</strong>
                            <div class="validation-detail">
                                ${validation.differentPartnerEachSession.valid ? 
                                    '✓ Tidak ada pasangan yang berulang' : 
                                    `⚠ Ada ${validation.differentPartnerEachSession.repeatCount} pasangan yang berulang`}
                            </div>
                        </div>
                    </div>
                `;
                
                // 3. Validasi ruang off
                html += `
                    <div class="validation-item">
                        <div class="validation-icon ${validation.offRoomsHandled.valid ? 'icon-ok' : 'icon-warning'}">
                            ${validation.offRoomsHandled.valid ? '✓' : '⚠'}
                        </div>
                        <div class="validation-text">
                            <strong>Penanganan ruang off</strong>
                            <div class="validation-detail">
                                ${validation.offRoomsHandled.details[validation.offRoomsHandled.details.length - 1] || 
                                 '✓ Tidak ada ruang off'}
                            </div>
                        </div>
                    </div>
                `;
                
                // 4. Validasi pemerataan tugas
                const distributionStatus = validation.taskDistribution.maxDiff <= 2 ? 'icon-ok' : 
                                         validation.taskDistribution.maxDiff <= 3 ? 'icon-warning' : 'icon-error';
                const distributionIcon = validation.taskDistribution.maxDiff <= 2 ? '✓' : 
                                       validation.taskDistribution.maxDiff <= 3 ? '⚠' : '✗';
                
                html += `
                    <div class="validation-item">
                        <div class="validation-icon ${distributionStatus}">
                            ${distributionIcon}
                        </div>
                        <div class="validation-text">
                            <strong>Pemerataan jumlah tugas pengawasan</strong>
                            <div class="validation-detail">
                                Selisih tugas: ${validation.taskDistribution.maxDiff} 
                                ${validation.taskDistribution.valid ? 
                                    '(Optimal: ≤ 2)' : 
                                    '(Perlu perbaikan)'}
                            </div>
                        </div>
                    </div>
                `;
                
                validationItems.innerHTML = html;
            }
            
            // Fungsi untuk menampilkan jadwal dengan ruang off
            function displayScheduleWithOffRooms(schedule, pengawasList, sesiCount, ruangCount, offRoomsMap) {
                let tableHTML = `
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th rowspan="2">Sesi</th>`;
                
                // Header ruang
                for (let ruang = 1; ruang <= ruangCount; ruang++) {
                    tableHTML += `<th colspan="2" class="ruang-header">Ruang ${ruang.toString().padStart(2, '0')}</th>`;
                }
                
                tableHTML += `</tr><tr>`;
                
                // Subheader untuk setiap ruang
                for (let ruang = 1; ruang <= ruangCount; ruang++) {
                    tableHTML += `<th class="ruang-subheader">Pengawas 1</th>`;
                    tableHTML += `<th class="ruang-subheader">Pengawas 2</th>`;
                }
                
                tableHTML += `</tr></thead><tbody>`;
                
                // Isi tabel
                for (let sesi = 0; sesi < sesiCount; sesi++) {
                    const offRooms = offRoomsMap[sesi + 1] || [];
                    tableHTML += `<tr><td class="sesi-header"><strong>Sesi ${schedule[sesi].sesi}</strong></td>`;
                    
                    for (let ruang = 0; ruang < ruangCount; ruang++) {
                        const cell = schedule[sesi].ruang[ruang];
                        const isOff = offRooms.includes(ruang + 1);
                        
                        if (isOff || cell.isOff) {
                            tableHTML += `<td colspan="2" class="cell-off">OFF</td>`;
                            // Karena colspan 2, kita perlu skip kolom berikutnya
                            // Tapi karena kita sudah buat 2 td terpisah, kita perlu penanganan khusus
                            // Mari kita ubah logikanya:
                        } else {
                            tableHTML += `<td class="pengawas-cell">${cell.pengawas1 || '?'}</td>`;
                            tableHTML += `<td class="pengawas-cell">${cell.pengawas2 || '?'}</td>`;
                        }
                    }
                    
                    tableHTML += `</tr>`;
                }
                
                tableHTML += `</tbody></table>`;
                
                scheduleTableContainer.innerHTML = tableHTML;
                
                // Update tampilan header untuk ruang off
                updateTableHeadersForOffRooms(ruangCount, offRoomsMap);
            }
            
            // Fungsi untuk update header tabel berdasarkan ruang off
            function updateTableHeadersForOffRooms(ruangCount, offRoomsMap) {
                const table = document.getElementById('scheduleTable');
                if (!table) return;
                
                // Hitung semua ruang yang pernah off
                const allOffRooms = new Set();
                Object.values(offRoomsMap).forEach(offRooms => {
                    offRooms.forEach(ruang => allOffRooms.add(ruang));
                });
                
                // Update header untuk ruang yang pernah off
                const headers = table.querySelectorAll('.ruang-header, .ruang-subheader');
                headers.forEach(header => {
                    const ruangMatch = header.textContent.match(/Ruang (\d+)/);
                    if (ruangMatch) {
                        const ruangNum = parseInt(ruangMatch[1]);
                        if (allOffRooms.has(ruangNum) && showOffRooms) {
                            header.classList.add('off');
                        } else {
                            header.classList.remove('off');
                        }
                    }
                });
            }
            
            // Fungsi untuk toggle tampilan ruang off
            function toggleOffRoomsDisplay() {
                showOffRooms = !showOffRooms;
                
                const table = document.getElementById('scheduleTable');
                if (!table) return;
                
                // Toggle class 'off' pada header
                const headers = table.querySelectorAll('.ruang-header.off, .ruang-subheader.off');
                headers.forEach(header => {
                    if (showOffRooms) {
                        header.style.display = '';
                    } else {
                        header.style.display = 'none';
                    }
                });
                
                // Toggle baris yang berisi "OFF"
                const offCells = table.querySelectorAll('.cell-off');
                offCells.forEach(cell => {
                    if (showOffRooms) {
                        cell.style.display = '';
                    } else {
                        cell.style.display = 'none';
                    }
                });
                
                toggleOffRoomsBtn.textContent = showOffRooms ? 
                    'Sembunyikan Ruang Off' : 'Tampilkan Ruang Off';
            }
            
            // Fungsi untuk menampilkan statistik dengan ruang off
            function displayStatsWithOffRooms(schedule, pengawasList, validation, offRoomsMap) {
                // Hitung jumlah tugas per pengawas
                const tugasCount = {};
                pengawasList.forEach(p => tugasCount[p] = 0);
                
                // Hitung ruang aktif per sesi
                let totalActiveRooms = 0;
                
                schedule.forEach(sesi => {
                    const offRooms = offRoomsMap[sesi.sesi] || [];
                    const activeRoomsInSession = sesi.ruang.filter(r => !offRooms.includes(r.ruang) && !r.isOff);
                    totalActiveRooms += activeRoomsInSession.length;
                    
                    activeRoomsInSession.forEach(ruang => {
                        if (ruang.pengawas1 && ruang.pengawas1 !== '?') tugasCount[ruang.pengawas1]++;
                        if (ruang.pengawas2 && ruang.pengawas2 !== '?') tugasCount[ruang.pengawas2]++;
                    });
                });
                
                // Hitung statistik hanya untuk pengawas yang aktif
                const activePengawas = pengawasList.filter(p => tugasCount[p] > 0);
                const tugasValues = activePengawas.map(p => tugasCount[p]);
                const totalTugas = tugasValues.reduce((a, b) => a + b, 0);
                const rataRataTugas = activePengawas.length > 0 ? totalTugas / activePengawas.length : 0;
                const maxTugas = tugasValues.length > 0 ? Math.max(...tugasValues) : 0;
                const minTugas = tugasValues.length > 0 ? Math.min(...tugasValues) : 0;
                const selisih = maxTugas - minTugas;
                
                // Hitung total ruang off
                let totalOffRooms = 0;
                Object.values(offRoomsMap).forEach(arr => totalOffRooms += arr.length);
                
                // Tentukan badge untuk selisih tugas
                let selisihBadge = '';
                if (selisih <= 1) {
                    selisihBadge = '<span class="badge badge-success">Optimal</span>';
                } else if (selisih <= 2) {
                    selisihBadge = '<span class="badge badge-warning">Baik</span>';
                } else {
                    selisihBadge = '<span class="badge badge-danger">Perlu Perbaikan</span>';
                }
                
                let statsHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${activePengawas.length}</div>
                        <div class="stat-label">Pengawas Aktif</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${rataRataTugas.toFixed(1)}</div>
                        <div class="stat-label">Rata-rata Tugas per Pengawas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${selisih} ${selisihBadge}</div>
                        <div class="stat-label">Selisih Tugas (${minTugas} - ${maxTugas})</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalActiveRooms}</div>
                        <div class="stat-label">Total Ruang Aktif</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalOffRooms}</div>
                        <div class="stat-label">Total Ruang Off</div>
                    </div>
                `;
                
                statsContainer.innerHTML = statsHTML;
            }
            
            // Fungsi untuk select all tabel
            function selectAllTable() {
                const table = document.getElementById('scheduleTable');
                if (!table) return;
                
                const range = document.createRange();
                range.selectNode(table);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                
                selectAllBtn.textContent = 'Tabel Terpilih! Tekan Ctrl+C untuk Copy';
                selectAllBtn.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    selectAllBtn.textContent = 'Select All (Untuk Copy ke Excel)';
                    selectAllBtn.style.backgroundColor = '';
                }, 3000);
            }
            
            // Fungsi untuk print jadwal
            function printSchedule() {
                window.print();
            }
            
            // Event listener untuk input perubahan
            sesiCountInput.addEventListener('change', createOffRoomsInputs);
            ruangCountInput.addEventListener('change', createOffRoomsInputs);
            
            // Event listener utama
            generateBtn.addEventListener('click', generateScheduleWithOffRooms);
            selectAllBtn.addEventListener('click', selectAllTable);
            printBtn.addEventListener('click', printSchedule);
            toggleOffRoomsBtn.addEventListener('click', toggleOffRoomsDisplay);
            
            // Inisialisasi awal
            createOffRoomsInputs();
            generateScheduleWithOffRooms();
        });
    </script>
</body>
</html>
